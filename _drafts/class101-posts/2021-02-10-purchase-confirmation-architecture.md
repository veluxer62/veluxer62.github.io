---
layout: single
title: "구매확정기능 설계"
categories:
  - POST
---

# 구매 확정 기능?

배송 시작 후 7일이 지나면 클래스메이트에게 문자 메시지를 자동으로 발송하고 문자 발송 후 5일이 지나도 클래스메이트가 구매 건에 대한 확정을 하지 않을 경우 자동으로 해당 구매 건에 대해 구매 확정 처리하는 기능을 말한다.

단, 관리자가 임의로 구매 확정을 할 수 있다.

# 설계

## 기존 설계

![pre-purchase-confirmation-architecture](/assets/images/draft/class101-posts/pre-purchase-confirmation-architecture.png)

## 새로운 설계

![post-purchase-confirmation-architecture](/assets/images/draft/class101-posts/post-purchase-confirmation-architecture.png)

# MQ 도입 배경

## ~~왜 Amazon MQ인가?~~

~~기능 구현 시 MQ를 사용하게 된 배경을 설명하기에 앞서 다양한 MQ 중에 왜 Amazon MQ를 선택 했는 지에 대한 내용을 먼저 말하면 좋을 것 같다.~~

- ~~메시지 지연 발송 지원~~

    ~~Amazon MQ는 메시지 지연 발송 기능을 간단한 설정을 통해 제공해준다. 우리가 구현해야 할 기능 중에 가장 주요하게 요구되는 기능이다.~~

- ~~AWS에서 관리 형 서비스 지원~~

    ~~MQ를 별도 Docker에 설치하고 사용하는 것은 가용성이나 관리 이슈 발생 가능성이 높아서 AWS에서 서비스 형태로 제공하는 지 여부가 MQ 선택의 중요한 고려 사항이었다.~~

~~이외에도 발행/구독 모델 지원과 자바와 호환성, 테스팅 용이성 등이 있는데 현재 구현해야 할 요구 사항에는 부합하지 않는 장점이라 크게 다루지는 않겠다.~~

## 주문 정보에 상태 값 추가를 최소화

기존 설계에서 배치 JOB으로 배송 중 또는 배송 완료의 상품에 대한 주문 정보를 찾는 쿼리를 작성하기 위해서는 주문 정보에 문자 발송, 문자 발송 시간, 배송 확정 여부 등등 추가적인 상태 값이 추가되어야 한다. 상태의 계속된 추가는 좋지 않다고 판단 하였고, 추후 추가 요구 사항이나 변경 요구 시 상태 값의 변경이 불가피할 수도 있기 때문에 상태 값을 추가하는 것을 최대한 피하고자 하였다.

> 새로운 설계 에서는 문자 발송과 배송 확정에 대한 추가적인 상태 값을 주문 정보에 추가할 필요 없다. 왜냐하면 MQ가 메시지 발송을 제 시간에 해줄 것이기 때문에 배치가 문자 발송이나 배송 확정을 위한 상태를 체크 해야 할 필요가 없기 때문이다. 다만, 문자 발송과 배송 확정 이력을 위한 컬렉션을 추가할 예정인데, 이는 중복된 메시지 발송 방지와 개발자의 트러블 슈팅을 위한 용도이다.

## 서비스 관리 포인트 감소

배치 JOB의 존재는 우리가 이 특정 주기마다 실행되는 JOB의 영향도를 인지하고 있어야 하며 시스템 배포나 서버의 상태에 따라 배치가 정상적으로 실행하는 지, JOB이 실패하는 경우 어떻게 대처해야 하는지를 고민해야 한다. 또 우리가 앞으로 배포 시 배치 스케줄을 체크해야 할 수도 있다. 

> 우리는 발송된 메시지가 제대로 제시간에 전달 됨을 믿고 사용할 수 있다.(라이브러 그러므로 우리는 운영 시 작업 리소스를 줄일 수 있을 것이라 예상했다.

## 시스템 부하와 전달 시간, 안정성 개선

배치 JOB으로 주문 데이터를 일괄적으로 조회해서 문자를 발송할지 구매 확정을 처리할 지 처리하는 기능을 개발한다면 아래와 같은 부분을 고려해야 했다.

- 얼마나 자주 JOB을 실행할 것인가?

    처리 시간의 정확성을 위해서는 JOB의 주기가 짧을 수록 좋으나 그만큼 시스템의 부하 및 JOB이 실행 중에 또다른 JOB이 실행되는 문제 처리 등 고려 해야 할 사항이 많다.

- 전송되어야 하는 문자 메시지가 사용자에게 제시간에 전달되어야 하나?

    이 부분은 요구사항에 따라 다르고 한 두 시간 지연된다고 해서 큰 문제는 되지 않을 것이라 판단되지만 내가 주문한 시간으로부터 정확히 7일 뒤에 전송이 된다면 좋을 것 같다.

- 일괄적으로 조회해서 데이터를 처리하는 중에 실패가 발생하면 어떻게 해야 할까?

    Transaction의 범위는 배치 처리 시 항상 고민하는 문제인 것 같다. 그리고 배치 JOB 처리 시 로직 문제로 인한 실패 뿐만 아니라 서버 환경으로 인한 문제로 프로세스가 실패하는 경우가 많이 있다. 이런 경우 우리는 실패한 케이스에 대한 처리를 위한 상태 관리가 추가적으로 필요할 수 있다.

> MQ를 사용하면 메시지 전송 시 어느 시점에 메시지를 소비할지 시점을 정할 수 있다. 이 기능만으로 위에서 우리가 고민했던 JOB 실행 주기와 전달 시간에 대한 고민을 해결해 준다.

## 확장 가능성

만약 사용자가 결재가 완료 후 처리할 것들이 문자 발송, 구매 확정 외에 다른 추가적인 기능을 추가해야 하는 경우? MQ의 발행/구독 모델을 사용하여 손쉽게 메시지에 대한 구독자를 추가하여 결재 완료 코드에 추가적인 코드를 작성하지 않고 추가 요구사항에 대한 기능 구현이 가능하다.

# 고민거리

## 운영 경험의 부재

MQ를 이용한 어플리케이션 개발 운영 경험이 없다. 

> 다행히(?) 현재 구현해야 할 기능이 문제가 생겼을 때 상황에 대한 심각성이 높지 않다고 생각되어 그렉의 허락을 받아서 도전을 해보려고 한다. 좋은 사례로 남아서 앞으로 MQ를 적극적으로 이용할 수 있으면 좋을 것 같다.

## 유지보수

MQ를 이용한 도메인 설계 시 느슨한 결합을 이용한 유연한 설계를 장점으로 말하곤 한다. 하지만 이러한 느슨한 결합이 마냥 좋은 것만은 아니라 생각이 든다. 결합이 낮은 만큼 메시지와 Queue, Topic의 Destination 관리도 잘해야 하고, Transaction 처리의 어려움, 전체 시스템 flow 이해가 어렵다는 점등 문제점은 우리가 함께 고민하면 좋을 것 같다.

# 기타

처음에 계획했던 Amazon MQ의 사용은 새로운 서비스 추가 보다는 기존에 사용하던 서비스를 이용해 보는 게 좋겠다는 의견을 받아 Kafka로 변경 하기로 결정하였다. 하지만 아쉽게도 Kafka에서는 Delayed Queue 기능을 지원하지 않아 보였다 😥

[In Apache Kafka, how can one achieve delay queue support (similar to what ActiveMQ has)?](https://www.quora.com/In-Apache-Kafka-how-can-one-achieve-delay-queue-support-similar-to-what-ActiveMQ-has)

그럼 이미 사용 중인 환경에서 Delay Delivery 기능을 사용할 수 있는 게 무엇이 있을 지 찾아보았고 다행히 현재 Apollo Server에서 캐시를 위한 용도로 사용하는 Redis가 Delay Tasks 기능을 제공한다는 것을 알게 되었다.

[6.4.2 Delayed tasks | Redis Labs](https://redislabs.com/ebook/part-2-core-concepts/chapter-6-application-components-in-redis/6-4-task-queues/6-4-2-delayed-tasks/)

실제로 테스트를 해봐야 알겠지만 제약 사항에 대한 언급이 따로 없어서 원래 사용하려고 했던 기능을 구현할 수 있을 것이라는 예상을 해본다. 아래는 Redis의 Queue 기능을 Node에서 사용하기 위한 라이브러리 다.

[OptimalBits/bull](https://github.com/OptimalBits/bull)